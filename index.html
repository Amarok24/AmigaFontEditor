<!DOCTYPE HTML>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/AmigaFontEditor.css">
	<script src="js/AmigaFontEditor.js"></script>
  </head>
  <body>
	<a href="https://github.com/Ozzyboshi/AmigaFontEditor"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>

	<div id="content" style="padding:50px">
		<h2>Amiga font editor</h2>
		<h4>Draw your fonts on the left grids and get the binary raw data to load into the Amiga copperlist</h4>
		<div id="colorpalette">
			<input type="file" id="fileChooser" style="display:none;">
			<input id="nbitplanes" type="range" min="1" max="5" step="1" value="5" /><a id="bitplaneslabel">Bitplanes :5</a>
			<ul id="colorslist">
				<li><input type=color id="color0" value="#ffffff">Color 00</li>
				<li><input type=color id="color1" value="#ff0000">Color 01</li>
				<li><input type=color id="color2" value="#00ff00">Color 02</li>
				<li><input type=color id="color3" value="#0000ff">Color 03</li>
				<li><input type=color id="color4" value="#000000">Color 04</li>
				<li><input type=color id="color5" value="#ff00ff">Color 05</li>
				<li><input type=color id="color6" value="#ff00ff">Color 06</li>
				<li><input type=color id="color7" value="#ff00ff">Color 07</li>
				<li><input type=color id="color8" value="#ff00ff">Color 08</li>
				<li><input type=color id="color9" value="#ff00ff">Color 09</li>
				<li><input type=color id="color10" value="#ff00ff">Color 10</li>
				<li><input type=color id="color11" value="#ff00ff">Color 11</li>
				<li><input type=color id="color12" value="#ff00ff">Color 12</li>
				<li><input type=color id="color13" value="#ff00ff">Color 13</li>
				<li><input type=color id="color14" value="#ff00ff">Color 14</li>
				<li><input type=color id="color15" value="#ff00ff">Color 15</li>
				<li><input type=color id="color16" value="#ff00ff">Color 16</li>
				<li><input type=color id="color17" value="#ff00ff">Color 17</li>
				<li><input type=color id="color18" value="#ff00ff">Color 18</li>
				<li><input type=color id="color19" value="#ff00ff">Color 19</li>
				<li><input type=color id="color20" value="#ff00ff">Color 20</li>
				<li><input type=color id="color21" value="#ff00ff">Color 21</li>
				<li><input type=color id="color22" value="#ff00ff">Color 22</li>
				<li><input type=color id="color23" value="#ff00ff">Color 23</li>
				<li><input type=color id="color24" value="#ff00ff">Color 24</li>
				<li><input type=color id="color25" value="#ff00ff">Color 25</li>
				<li><input type=color id="color26" value="#ff00ff">Color 26</li>
				<li><input type=color id="color27" value="#ff00ff">Color 27</li>
				<li><input type=color id="color28" value="#ff00ff">Color 28</li>
				<li><input type=color id="color29" value="#ff00ff">Color 29</li>
				<li><input type=color id="color30" value="#ff00ff">Color 30</li>
				<li><input type=color id="color31" value="#ff00ff">Color 31</li>
			</ul>
		</div>
		<div id=result>
			<div id="buttondiv">
			<input type=button id=showbin value="Show Binary">
			<input type=button id=showhex value="Show Hex">
			<input type=button id=calculate value="Generate Raw File">
			<input type="button" value="Import From Raw File" onclick="document.getElementById('fileChooser').click();" />
			
			</div>
			
			
			
			<pre id="resultpre"></pre>
		
			
		</div>
		<ul id="fonttable"></ul>
	</div>
    <script>
      var NUMPALETTECOLORS=32; // Amiga internal registers manage up to 32 colors (from DFF180 (color 00 to DFF1BE color 31)
      var SQUARE_PIXELS = 10; // Pixel needed to draw a square
	  var XRES = 8;
	  var YRES = 8;

	  // Create list of characters
	  var charset = [];

	  for (var i = 32; i <= 127; i++) {
   		charset.push(i);
	  }

	  var table=createFontTable(charset);
	  table.createList(document.getElementById("fonttable"));

	  // Manage slider for changing bitplane numbers
	  document.getElementById('nbitplanes').addEventListener('change',handleChangeBitplaneNumber,false);
	  function handleChangeBitplaneNumber(event)
	  {
	  	console.log(this.value);
	  	// Hide out of range palettes
	  	for (i=0;i<NUMPALETTECOLORS;i++)
	  	{
	  		var liColor=document.querySelectorAll("#colorslist > li")[i];
	  		if (i<Math.pow(2,this.value*1))
	  			liColor.style = "display: show";
	  		else
	  			liColor.style = "display: none";
	  	}

	  	//Bitplane label update
	  	document.getElementById('bitplaneslabel').innerHTML='Bitplanes :'+this.value;
	  }

	  // Manage palette change color
	  for (i=0;i<NUMPALETTECOLORS;i++)
	  document.querySelectorAll("#colorslist > li > input[type=color]")[i].addEventListener('input',handleChangePaletteColor, false);
	  function handleChangePaletteColor(event) {
	  	var rgb=hexToRgb(this.value);
	  	var amigaR=Math.round(rgb.r*15/255).toString(16);
	  	var amigaG=Math.round(rgb.g*15/255).toString(16);
	  	var amigaB=Math.round(rgb.b*15/255).toString(16);
	  	console.log(amigaR+'-'+amigaG+'-'+amigaB);
	  }

	  // Manage color selection
	  for (i=0;i<NUMPALETTECOLORS;i++) document.querySelectorAll("#colorslist > li")[i].addEventListener('click',handleChangeColor, false);
	  function handleChangeColor(event) { 
	  for (i=0;i<NUMPALETTECOLORS;i++)
	  	document.querySelectorAll("#colorslist > li")[i].style.background='#9e9e9e';
	  this.style.backgroundColor  = 'red';

	}

	var calculate = document.getElementById('calculate');
	calculate.onclick = function() {
		fontArray=table.fontArray;
		var binaryData = new Uint8Array(XRES*YRES/8*fontArray.length);
		var offset=0;
		
		for (var i = 0; i < fontArray.length; i++) {
			//console.log(fontArray[i]);	
			var canvas=fontArray[i].canvas;
			//console.log(canvas.data.getBinaryDataString());
			binaryCharacters=canvas.data.getBinaryDataString();
			var hex = parseInt(binaryCharacters, 2).toString(16);
			//console.log(hex);
			sampleBytes=canvas.data.getBinaryData();
			console.log("Sabplebytes"+sampleBytes);
			//binaryData=concatenate(Uint8Array,sampleBytes,Uint8Array.of(sampleBytes));
			binaryData.set(sampleBytes,offset);
			offset+=sampleBytes.length;
			console.log(binaryData);
		}
		var fileName = prompt("Please enter the name of your export file", "Myfonts.fnt");
		if (fileName)
			saveByteArray([binaryData], fileName);
	};

	var showbin=document.getElementById('showbin');
	showbin.onclick = function() {
		var binaryCharacters="";
		for (var i = 0; i < table.fontArray.length; i++) {
			var canvas=table.fontArray[i].canvas;
			binaryCharacters+=canvas.data.getBinaryDataString();
		}
		var formattedBinary=chunk(binaryCharacters, 8).join(' ');
		var formattedBinary=chunk(formattedBinary, 72).join('\n');

		document.getElementById("resultpre").innerHTML = formattedBinary;
	};

	var showhex=document.getElementById('showhex');
	showhex.onclick = function() {
		var binaryCharacters="";
		var hex="";
		//var offset=0;
		//var binaryData = new Uint8Array(XRES*YRES/8*table.fontArray.length);
		for (var i = 0; i < table.fontArray.length; i++) {
			var canvas=table.fontArray[i].canvas;
			binaryCharacters+=canvas.data.getBinaryDataString();
			/*sampleBytes=canvas.data.getBinaryData();
			binaryData.set(sampleBytes,offset);
			offset+=sampleBytes.length;*/
			hex+=canvas.data.getHexDataString();
		}
		//var hex = parseInt(binaryCharacters, 2).toString(16);
		var formattedHex=chunk(hex, 2).join(' ');
		var formattedHex=chunk(formattedHex, 24).join('\n');

		document.getElementById("resultpre").innerHTML = formattedHex;
	};



	var saveByteArray = (function () {
		var a = document.createElement("a");
		document.body.appendChild(a);
		a.style = "display: none";
		return function (data, name) {
		    var blob = new Blob(data, {type: "octet/stream"}),
		        url = window.URL.createObjectURL(blob);
		    a.href = url;
		    a.download = name;
		    a.click();
		    window.URL.revokeObjectURL(url);
		};
	}());

	function chunk(str, n) {
		var ret = [];
		var i;
		var len;

		for(i = 0, len = str.length; i < len; i += n) {
		   ret.push(str.substr(i, n))
		}

		return ret
   };

	document.querySelector("#fileChooser").addEventListener('change',filesChosen, false);
	function filesChosen(evt){
		var chosenFile = evt.target.files[0]; //get the first file in the FileList
		var fileName = chosenFile.name; //the name of the file as a string
		var fileSize = chosenFile.size; //the size of the file in bytes, as an integer
		var fileModifiedDate = chosenFile.lastModifiedDate; //a Date object
		console.log(chosenFile);
		reader = new FileReader();
		//reader.addEventListener("load", readFile, false);
		reader.readAsArrayBuffer(document.querySelector("#fileChooser").files[0]);
		reader.onloadend = function () {
			//console.log(reader.result);
			var view   = new Uint8Array(reader.result);
			//console.log(view);
			var fontCounter=0;
			var bitCounter=0;
			var bitArray = [];
			for (var i=0;i<view.length;i++)
			{
				//console.log(i+"-"+view[i]);
				var arrayConverter = [];
				for (bytevalue=view[i],j=0;j<8;j++)
				{
					//console.log(i+"-"+j+"-"+bytevalue+"--->"+bytevalue%2);
					//bitArray[bitCounter]=bytevalue%2;
					arrayConverter.push(bytevalue%2);
					bitCounter++;
					
					bytevalue=Math.floor(bytevalue/2);
				}
				arrayConverter=arrayConverter.reverse();
				bitArray=bitArray.concat(arrayConverter);
				if (bitCounter>=XRES*YRES){ table.fontArray[fontCounter].setSquares(bitArray);bitCounter=0;bitArray = [];fontCounter++; }
			}
			alert('File loaded succesfully');
		  }

	}
	function hexToRgb(hex) {
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}
	
    </script>
  </body>
</html>  
